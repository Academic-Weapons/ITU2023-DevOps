DO_BOX_URL = "https://github.com/devopsgroup-io/vagrant-digitalocean/raw/master/box/digital_ocean.box"
PRIVATE_KEY_PATH = "id_rsa"
PUBLIC_KEY_PATH="id_rsa.pub"
TOKEN = "dop_v1_4242a52672d0bce878f9c4e63779775b4e33c1cf6adac68f78e422a6c069afe8"

Vagrant.configure("2") do |config|
  config.vm.define "minitwit1" do |droplet|
    droplet.vm.provider :digital_ocean do |provider, override|
      override.ssh.private_key_path = PRIVATE_KEY_PATH
      override.vm.box = 'digital_ocean'
      override.vm.box_url = DO_BOX_URL
      override.nfs.functional = false
      override.vm.allowed_synced_folder_types = :rsync
      provider.token = TOKEN
      provider.image = 'ubuntu-18-04-x64'
      provider.region = 'fra1'
    #   provider.size = '8gb'

    config.vm.synced_folder ".", "/vagrant", type: "rsync"
    


    config.vm.provision "shell", inline: <<-SHELL
    sudo apt-get update
    sudo apt-get install -y openjdk-17-jdk maven sqlite3 libsqlite3-dev tomcat9

    # Add public key to authorized_keys file
    mkdir -p /home/vagrant/.ssh
    chmod 700 /home/vagrant/.ssh
    echo #{PUBLIC_KEY_PATH} >> /home/vagrant/.ssh/authorized_keys
    chmod 600 /home/vagrant/.ssh/authorized_keys
    chown -R $USER:$USER /home/vagrant/.ssh
    
    # Lanuch war file
    nohup java -jar /vagrant/MiniTwit/target/MiniTwit-0.0.1-SNAPSHOT.war > /vagrant/minitwit.log 2>&1 &
    sleep 30s
    SHELL

    end
  end
end